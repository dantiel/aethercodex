<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>beforeRunningCommand</key>
  <string>nop</string>
  <key>command</key>
  <string><![CDATA[#!/usr/bin/env bash
set -e
SUP="$TM_BUNDLE_SUPPORT"
export BUNDLE_GEMFILE="$SUP/Gemfile"
export GEM_HOME="$SUP/.vendor_bundle"
export GEM_PATH="$GEM_HOME"

# Ensure server is running & get port
JSON=$(bundle exec ruby "$SUP/boot.rb")
PORT=$(echo "$JSON" | ruby -rjson -e 'puts JSON.parse(STDIN.read)["port"]')

# Call file_overview tool for current file
RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" -d \
  "{\"method\":\"tool\",\"params\":{\"tool\":\"file_overview\",\"args\":{\"path\":\"$TM_FILEPATH\"}}}" \
  "http://0.0.0.0:$PORT/api")

# Extract and format result
FORMATTED=$(echo "$RESPONSE" | ruby -rjson -e '
  response = JSON.parse ARGF.read
  data = response["result"]
  unless data["file_info"].nil?
    puts "File: #{data["file_info"]["path"]}\n"
    puts "Size: #{data["file_info"]["size"]} bytes\n"
    puts "Last modified: #{data["file_info"]["last_modified"]}\n\n"
    puts "Notes:\n"
    data["notes"].each { |note| puts "- #{note["content"]} (tags: #{note["tags"]&.split(",")&.join(", ")})" } if data["notes"]
  else
    puts "Nothing found."
    puts response.inspect 
  end
')
echo "$FORMATTED"
]]></string>
  <key>input</key>
  <string>none</string>
  <key>inputFormat</key>
  <string>text</string>
  <key>keyEquivalent</key>
  <string>^~O</string>
  <key>name</key>
  <string>AetherCodex: File Overview</string>
  <key>outputCaret</key>
  <string>afterOutput</string>
  <key>outputFormat</key>
  <string>text</string>
  <key>outputLocation</key>
  <string>toolTip</string>
  <key>uuid</key>
  <string>BFA51948-0ADB-4C4C-BB8F-906DA7A4EE4A</string>
  <key>version</key>
  <integer>2</integer>
</dict>
</plist>


